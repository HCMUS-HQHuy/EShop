enum USER_ROLE {
  ADMIN
  SELLER
  CUSTOMER
  GUEST
}

enum ORDER_STATUS {
  PENDING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum SHOP_STATUS {
  ACTIVE
  REJECTED
  PENDING_VERIFICATION
  CLOSED
  BANNED
}

enum USER_STATUS {
  ACTIVE
  BANNED
}

enum PAYMENT_STATUS {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PAYMENT_METHOD {
  MOMO
  COD
  BANK_TRANSFER
  PAYPAL
}

enum PRODUCT_STATUS {
  PENDING
  REJECTED
  ACTIVE
  INACTIVE
  BANNED
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Categories {
  categoryId        Int                 @id @default(autoincrement())
  iconName          String?             @db.VarChar(100)
  title             String              @unique @db.VarChar(100)
  description       String?
  parentId          Int?
  createdAt         DateTime?           @default(now()) @db.Timestamptz(6)
  isDeleted         Boolean             @default(false)
  deletedAt         DateTime?           @db.Timestamptz(6)
  deletedBy         Int?
  categories        Categories?         @relation("categoriesTocategories", fields: [parentId], references: [categoryId], onUpdate: NoAction)
  otherCategories   Categories[]        @relation("categoriesTocategories")
  users             Users?              @relation(fields: [deletedBy], references: [userId], onUpdate: NoAction, map: "fk_category_deletedBy")
  productCategories ProductCategories[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Conversations {
  conversationId   Int        @id @default(autoincrement())
  participant1Id   Int
  participant2Id   Int
  participant1Role String     @db.Char(10)
  participant2Role String     @db.Char(10)
  context          Json?
  createdAt        DateTime   @default(now()) @db.Timestamp(6)
  participant1     Users      @relation("conversations_participant1_idTousers", fields: [participant1Id], references: [userId], onDelete: Cascade, onUpdate: NoAction)
  participant2     Users      @relation("conversations_participant2_idTousers", fields: [participant2Id], references: [userId], onDelete: Cascade, onUpdate: NoAction)
  messages         Messages[]
}

model Messages {
  messageId      Int           @id @default(autoincrement())
  conversationId Int
  senderId       Int
  content        String
  sentAt         DateTime      @default(now()) @db.Timestamp(6)
  isRead         Boolean?      @default(false)
  conversation   Conversations @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade, onUpdate: NoAction)
  user           Users         @relation(fields: [senderId], references: [userId], onDelete: Cascade, onUpdate: NoAction)
}

model OrderItems {
  orderItemId Int      @id @default(autoincrement())
  orderId     Int
  productId   Int
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  order       Orders   @relation(fields: [orderId], references: [orderId], onDelete: Cascade, onUpdate: NoAction, map: "fk_order_item_order")
  product     Products @relation(fields: [productId], references: [productId], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_item_product")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Orders {
  orderId         Int          @id @default(autoincrement())
  shopId          Int
  userId          Int
  receiverName    String       @db.VarChar(100)
  shippingAddress String       @db.VarChar(255)
  phoneNumber     String       @db.VarChar(15)
  email           String       @db.VarChar(100)
  total           Decimal      @db.Decimal(12, 2)
  shippingFee     Decimal      @default(0) @db.Decimal(12, 2)
  discount        Decimal      @default(0) @db.Decimal(12, 2)
  final           Decimal      @db.Decimal(12, 2)
  status          ORDER_STATUS @default(PENDING)
  createdAt       DateTime?    @default(now()) @db.Timestamptz(6)
  orderItems      OrderItems[]
  shop            Shops        @relation(fields: [shopId], references: [shopId], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_shop")
  user            Users        @relation(fields: [userId], references: [userId], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_user")
  payments        Payments[]
}

model PaymentMethods {
  paymentMethodId Int        @id @default(autoincrement())
  code            String     @unique @db.VarChar(20)
  name            String     @db.VarChar(100)
  img             String?    @db.VarChar(255)
  link            String?    @db.VarChar(255)
  isActive        Boolean    @default(true)
  payments        Payments[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Payments {
  paymentId         Int            @id @default(autoincrement())
  orderId           Int
  paymentCode       String         @unique @db.VarChar(20)
  paymentMethodCode String         @db.VarChar(20)
  amount            Decimal        @db.Decimal(12, 2)
  status            ORDER_STATUS   @default(PENDING)
  paymentMethod     PaymentMethods @relation(fields: [paymentMethodCode], references: [code], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_method")
  order             Orders         @relation(fields: [orderId], references: [orderId], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_order")
}

model ProductCategories {
  productId  Int
  categoryId Int
  category   Categories @relation(fields: [categoryId], references: [categoryId], onDelete: Cascade, onUpdate: NoAction)
  product    Products   @relation(fields: [productId], references: [productId], onDelete: Cascade, onUpdate: NoAction)

  @@id([productId, categoryId])
}

model ProductImages {
  imageId   Int       @id @default(autoincrement())
  productId Int
  imageUrl  String    @db.VarChar(255)
  createdAt DateTime? @default(now()) @db.Timestamptz(6)
  isDeleted Boolean   @default(false)
  deletedAt DateTime? @db.Timestamptz(6)
  deletedBy Int?
  user      Users?    @relation(fields: [deletedBy], references: [userId], onUpdate: NoAction, map: "fk_image_deletedBy")
  product   Products  @relation(fields: [productId], references: [productId], onDelete: Cascade, onUpdate: NoAction, map: "fk_image_product")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Products {
  productId         Int                 @id @default(autoincrement())
  sku               String              @db.VarChar(100)
  shortName         String              @db.VarChar(255)
  name              String              @db.VarChar(255)
  price             Decimal             @db.Decimal(10, 2)
  discount          Decimal             @default(0) @db.Decimal(5, 2)
  description       String?
  stockQuantity     Int
  imageUrl          String?             @db.VarChar(255)
  shopId            Int
  status            PRODUCT_STATUS      @default(PENDING)
  createdAt         DateTime?           @default(now()) @db.Timestamptz(6)
  isDeleted         Boolean             @default(false)
  deletedAt         DateTime?           @db.Timestamptz(6)
  deletedBy         Int?
  orderItems        OrderItems[]
  productCategories ProductCategories[]
  productImages     ProductImages[]
  user              Users?              @relation(fields: [deletedBy], references: [userId], onUpdate: NoAction, map: "fk_product_deletedBy")
  shop              Shops               @relation(fields: [shopId], references: [shopId], onDelete: NoAction, onUpdate: NoAction, map: "fk_product_shop")

  @@unique([sku, shopId], map: "uq_product_sku_shop")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Shops {
  shopId          Int         @id @default(autoincrement())
  userId          Int         @unique
  shopName        String      @db.VarChar(100)
  email           String      @unique @db.VarChar(100)
  phoneNumber     String      @db.VarChar(15)
  shopDescription String?
  address         String      @db.VarChar(255)
  status          SHOP_STATUS @default(PENDING_VERIFICATION)
  adminNote       String?
  createdAt       DateTime?   @default(now()) @db.Timestamptz(6)
  orders          Orders[]
  products        Products[]
  user            Users       @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "fk_shop_user")
}

model Tokens {
  tokenId   Int       @id @default(autoincrement())
  userId    Int
  token     String    @db.VarChar(255)
  createdAt DateTime? @default(now()) @db.Timestamptz(6)
  expiresAt DateTime  @db.Timestamptz(6)
  user      Users     @relation(fields: [userId], references: [userId], onDelete: Cascade, onUpdate: NoAction, map: "fk_token_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Users {
  userId                    Int             @id @default(autoincrement())
  username                  String          @unique @db.VarChar(50)
  password                  String
  email                     String          @unique @db.VarChar(100)
  address                   String?         @db.VarChar(255)
  phoneNumber               String?         @db.VarChar(15)
  role                      USER_ROLE       @default(CUSTOMER)
  status                    USER_STATUS     @default(ACTIVE)
  isVerified                Boolean         @default(false)
  createdAt                 DateTime?       @default(now()) @db.Timestamptz(6)
  isDeleted                 Boolean         @default(false)
  deletedAt                 DateTime?       @db.Timestamptz(6)
  categories                Categories[]
  conversationsParticipant1 Conversations[] @relation("conversations_participant1_idTousers")
  conversationsParticipant2 Conversations[] @relation("conversations_participant2_idTousers")
  messages                  Messages[]
  orders                    Orders[]
  productImages             ProductImages[]
  products                  Products[]
  shop                      Shops?
  tokens                    Tokens[]
}
